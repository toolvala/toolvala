<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo & Signature Merger Tool</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.8rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .subtitle {
            color: #666;
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .app-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 40px;
        }

        .left-panel {
            flex: 1;
            min-width: 350px;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .right-panel {
            flex: 2;
            min-width: 700px;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }

        .panel-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .panel-title i {
            color: #667eea;
            background: #f0f0f0;
            padding: 10px;
            border-radius: 10px;
        }

        .upload-section {
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 1px solid #eee;
        }

        .section-title {
            font-size: 1.2rem;
            color: #444;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: #667eea;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(102, 126, 234, 0.05);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-3px);
        }

        .upload-area i {
            font-size: 60px;
            color: #667eea;
            margin-bottom: 15px;
            opacity: 0.8;
        }

        .upload-area p {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .upload-area span {
            color: #764ba2;
            font-weight: 600;
        }

        .file-input {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .image-preview {
            margin-top: 20px;
            text-align: center;
            position: relative;
        }

        .preview-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            object-fit: contain;
            background: #f8f9ff;
            padding: 10px;
        }

        .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s;
        }

        .remove-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .controls-section {
            margin-bottom: 25px;
        }

        .control-group {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .control-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-value {
            color: #667eea;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slider-container input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .position-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .position-btn {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            background: white;
            font-size: 1.5rem;
        }

        .position-btn:hover {
            border-color: #667eea;
        }

        .position-btn.active {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            flex: 1;
            min-width: 140px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .checkbox-label:hover {
            border-color: #667eea;
        }

        .checkbox-label input {
            width: auto;
        }

        .color-picker {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.active {
            border-color: #333;
            transform: scale(1.1);
        }

        .editor-container {
            flex: 1;
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 20px;
            background: #f8f9ff;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            min-height: 500px;
            margin-bottom: 30px;
        }

        #mergeCanvas {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            cursor: move;
            display: none;
        }

        .canvas-placeholder {
            text-align: center;
            color: #888;
            font-size: 1.1rem;
        }

        .canvas-placeholder i {
            font-size: 60px;
            color: #ccc;
            margin-bottom: 20px;
            display: block;
        }

        .draggable-element {
            position: absolute;
            cursor: move;
            border: 2px dashed transparent;
            transition: border-color 0.3s;
        }

        .draggable-element:hover {
            border-color: #667eea;
        }

        .element-controls {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
            background: rgba(0, 0, 0, 0.8);
            padding: 5px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .draggable-element:hover .element-controls {
            opacity: 1;
        }

        .control-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            color: #333;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background: #27ae60;
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(46, 204, 113, 0.3);
        }

        .btn-download {
            background: #e74c3c;
            color: white;
        }

        .btn-download:hover {
            background: #c0392b;
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
        }

        .btn-clear {
            background: #f39c12;
            color: white;
        }

        .btn-clear:hover {
            background: #d68910;
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(243, 156, 18, 0.3);
        }

        .btn-undo {
            background: #95a5a6;
            color: white;
        }

        .btn-undo:hover {
            background: #7f8c8d;
            transform: translateY(-3px);
        }

        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .template-card {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .template-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
        }

        .template-card.active {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .template-icon {
            font-size: 30px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #2ecc71;
            color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification.error {
            background: #e74c3c;
        }

        .tab-navigation {
            display: flex;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 20px;
            background: #f8f9ff;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: #666;
        }

        .tab-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .signature-canvas-container {
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-top: 15px;
            cursor: crosshair;
            background: white;
            position: relative;
        }

        #signatureCanvas {
            width: 100%;
            height: 200px;
            display: block;
            border-radius: 10px;
        }

        .canvas-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .canvas-btn {
            padding: 8px 15px;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .canvas-btn.clear {
            background: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }

        .canvas-btn.save {
            background: #2ecc71;
            color: white;
            border-color: #2ecc71;
        }

        .canvas-btn.undo {
            background: #f39c12;
            color: white;
            border-color: #f39c12;
        }

        .watermark-preview {
            margin-top: 15px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
            border: 2px dashed #ddd;
            text-align: center;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .history-stack {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 10px;
            background: white;
        }

        .history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.3s;
        }

        .history-item:hover {
            background: #f8f9ff;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #667eea;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .resize-handle.nw { top: -6px; left: -6px; cursor: nw-resize; }
        .resize-handle.ne { top: -6px; right: -6px; cursor: ne-resize; }
        .resize-handle.sw { bottom: -6px; left: -6px; cursor: sw-resize; }
        .resize-handle.se { bottom: -6px; right: -6px; cursor: se-resize; }
        .resize-handle.n { top: -6px; left: 50%; transform: translateX(-50%); cursor: n-resize; }
        .resize-handle.s { bottom: -6px; left: 50%; transform: translateX(-50%); cursor: s-resize; }
        .resize-handle.e { top: 50%; right: -6px; transform: translateY(-50%); cursor: e-resize; }
        .resize-handle.w { top: 50%; left: -6px; transform: translateY(-50%); cursor: w-resize; }

        @media (max-width: 1200px) {
            .app-container {
                flex-direction: column;
            }
            
            .left-panel, .right-panel {
                min-width: 100%;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .templates-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .position-controls {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .checkbox-label {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-layer-group"></i> Photo & Signature Merger</h1>
            <p class="subtitle">Merge photos with signatures, watermarks, and text. Perfect for documents, certificates, and professional use.</p>
        </header>

        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="merge-tab">
                <i class="fas fa-blender"></i> Merge Images
            </button>
            <button class="tab-btn" data-tab="signature-tab">
                <i class="fas fa-signature"></i> Create Signature
            </button>
            <button class="tab-btn" data-tab="batch-tab">
                <i class="fas fa-images"></i> Batch Process
            </button>
        </div>

        <!-- Merge Images Tab -->
        <div class="tab-content active" id="merge-tab">
            <div class="app-container">
                <div class="left-panel">
                    <div class="panel-title">
                        <i class="fas fa-sliders-h"></i> Controls & Settings
                    </div>

                    <!-- Photo Upload -->
                    <div class="upload-section">
                        <div class="section-title">
                            <i class="fas fa-image"></i> Upload Photo
                        </div>
                        <div class="upload-area" id="photoUploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop your photo here</p>
                            <p><span>or click to browse</span></p>
                            <input type="file" id="photoInput" class="file-input" accept="image/*">
                        </div>
                        <div class="image-preview">
                            <img id="photoPreview" class="preview-image" alt="Photo Preview">
                            <button class="remove-btn" id="removePhotoBtn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Signature Upload -->
                    <div class="upload-section">
                        <div class="section-title">
                            <i class="fas fa-signature"></i> Upload Signature
                        </div>
                        <div class="upload-area" id="signatureUploadArea">
                            <i class="fas fa-file-signature"></i>
                            <p>Drag & drop signature image</p>
                            <p><span>or use drawn signature</span></p>
                            <input type="file" id="signatureInput" class="file-input" accept="image/*">
                        </div>
                        <div class="image-preview">
                            <img id="signaturePreview" class="preview-image" alt="Signature Preview">
                            <button class="remove-btn" id="removeSignatureBtn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <button id="useDrawnSignature" class="btn" style="background: #9b59b6; color: white; width: 100%;">
                                <i class="fas fa-pen"></i> Use Drawn Signature
                            </button>
                        </div>
                    </div>

                    <!-- Merge Controls -->
                    <div class="controls-section">
                        <div class="section-title">
                            <i class="fas fa-cogs"></i> Merge Settings
                        </div>

                        <div class="control-group">
                            <label class="control-label">
                                Signature Size
                                <span class="control-value" id="sizeValue">100%</span>
                            </label>
                            <div class="slider-container">
                                <input type="range" id="sizeSlider" min="10" max="200" value="100">
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label">
                                Opacity
                                <span class="control-value" id="opacityValue">100%</span>
                            </label>
                            <div class="slider-container">
                                <input type="range" id="opacitySlider" min="10" max="100" value="100">
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label">
                                Rotation
                                <span class="control-value" id="rotationValue">0°</span>
                            </label>
                            <div class="slider-container">
                                <input type="range" id="rotationSlider" min="-180" max="180" value="0">
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label">Position Presets</label>
                            <div class="position-controls">
                                <button class="position-btn" data-position="top-left">↖</button>
                                <button class="position-btn" data-position="top-center">↑</button>
                                <button class="position-btn" data-position="top-right">↗</button>
                                <button class="position-btn" data-position="middle-left">←</button>
                                <button class="position-btn active" data-position="center">⦿</button>
                                <button class="position-btn" data-position="middle-right">→</button>
                                <button class="position-btn" data-position="bottom-left">↙</button>
                                <button class="position-btn" data-position="bottom-center">↓</button>
                                <button class="position-btn" data-position="bottom-right">↘</button>
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label">Signature Color</label>
                            <div class="color-picker">
                                <div class="color-option active" style="background: #000000;" data-color="original"></div>
                                <div class="color-option" style="background: #000000;" data-color="#000000"></div>
                                <div class="color-option" style="background: #ffffff; border: 1px solid #ccc;" data-color="#ffffff"></div>
                                <div class="color-option" style="background: #0000ff;" data-color="#0000ff"></div>
                                <div class="color-option" style="background: #ff0000;" data-color="#ff0000"></div>
                                <div class="color-option" style="background: #008000;" data-color="#008000"></div>
                                <input type="color" id="customColor" value="#000000" style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden;">
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label">Effects</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="invertSignature"> Invert Colors
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="removeBackground"> Remove White Background
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="addShadow"> Add Shadow
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="addBorder"> Add Border
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Templates -->
                    <div class="controls-section">
                        <div class="section-title">
                            <i class="fas fa-th-large"></i> Quick Templates
                        </div>
                        <div class="templates-grid">
                            <div class="template-card active" data-template="document">
                                <div class="template-icon">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <h4>Document</h4>
                            </div>
                            <div class="template-card" data-template="certificate">
                                <div class="template-icon">
                                    <i class="fas fa-award"></i>
                                </div>
                                <h4>Certificate</h4>
                            </div>
                            <div class="template-card" data-template="id-card">
                                <div class="template-icon">
                                    <i class="fas fa-id-card"></i>
                                </div>
                                <h4>ID Card</h4>
                            </div>
                            <div class="template-card" data-template="photo">
                                <div class="template-icon">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <h4>Photo</h4>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="right-panel">
                    <div class="panel-title">
                        <i class="fas fa-eye"></i> Preview & Editor
                    </div>
                    
                    <div class="editor-container" id="editorContainer">
                        <canvas id="mergeCanvas"></canvas>
                        <div class="canvas-placeholder" id="canvasPlaceholder">
                            <i class="fas fa-layer-group"></i>
                            <p>Upload a photo and signature to begin merging</p>
                            <p style="font-size: 0.9rem; color: #aaa; margin-top: 10px;">
                                Drag and resize elements directly on the canvas
                            </p>
                        </div>
                        <!-- Draggable signature will be added here -->
                    </div>
                    
                    <div class="action-buttons">
                        <button id="mergeBtn" class="btn btn-primary">
                            <i class="fas fa-blender"></i> Merge Now
                        </button>
                        <button id="resetBtn" class="btn btn-clear">
                            <i class="fas fa-redo"></i> Reset All
                        </button>
                        <button id="undoBtn" class="btn btn-undo">
                            <i class="fas fa-undo"></i> Undo
                        </button>
                        <button id="downloadBtn" class="btn btn-download">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>

                    <!-- History Stack -->
                    <div class="controls-section" style="margin-top: 20px;">
                        <div class="section-title">
                            <i class="fas fa-history"></i> Edit History
                        </div>
                        <div class="history-stack" id="historyStack">
                            <p style="color: #aaa; text-align: center; padding: 20px;">No edit history yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Signature Tab -->
        <div class="tab-content" id="signature-tab">
            <div class="app-container">
                <div class="left-panel">
                    <div class="panel-title">
                        <i class="fas fa-pen"></i> Create Signature
                    </div>

                    <div class="upload-section">
                        <div class="section-title">
                            <i class="fas fa-draw-polygon"></i> Draw Signature
                        </div>
                        <div class="signature-canvas-container">
                            <canvas id="drawCanvas"></canvas>
                        </div>
                        <div class="canvas-controls">
                            <button id="clearDrawBtn" class="canvas-btn clear">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                            <button id="undoDrawBtn" class="canvas-btn undo">
                                <i class="fas fa-undo"></i> Undo
                            </button>
                            <button id="saveDrawBtn" class="canvas-btn save">
                                <i class="fas fa-save"></i> Save
                            </button>
                        </div>
                    </div>

                    <div class="controls-section">
                        <div class="section-title">
                            <i class="fas fa-paint-brush"></i> Drawing Settings
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">
                                Brush Size
                                <span class="control-value" id="brushSizeValue">3px</span>
                            </label>
                            <div class="slider-container">
                                <input type="range" id="brushSize" min="1" max="20" value="3">
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label">Brush Color</label>
                            <div class="color-picker">
                                <div class="color-option active" style="background: #000000;" data-color="#000000"></div>
                                <div class="color-option" style="background: #0000ff;" data-color="#0000ff"></div>
                                <div class="color-option" style="background: #ff0000;" data-color="#ff0000"></div>
                                <div class="color-option" style="background: #008000;" data-color="#008000"></div>
                                <div class="color-option" style="background: #8b4513;" data-color="#8b4513"></div>
                                <input type="color" id="brushColor" value="#000000" style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden;">
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label">Paper Style</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="radio" name="paperStyle" value="white" checked> White
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="paperStyle" value="lined"> Lined
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="paperStyle" value="grid"> Grid
                                </label>
                                <label class="checkbox-label">
                                    <input type="radio" name="paperStyle" value="transparent"> Transparent
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="upload-section">
                        <div class="section-title">
                            <i class="fas fa-font"></i> Text Signature
                        </div>
                        <div class="control-group">
                            <label class="control-label">Name for Signature</label>
                            <input type="text" id="signatureText" placeholder="Enter your name" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1.1rem;">
                        </div>
                        <div class="control-group">
                            <label class="control-label">Font Style</label>
                            <select id="signatureFont" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <option value="'Brush Script MT', cursive">Brush Script</option>
                                <option value="'Dancing Script', cursive">Dancing Script</option>
                                <option value="'Great Vibes', cursive">Great Vibes</option>
                                <option value="'Parisienne', cursive">Parisienne</option>
                                <option value="'Allura', cursive">Allura</option>
                                <option value="'Pacifico', cursive">Pacifico</option>
                            </select>
                        </div>
                        <button id="generateTextSignature" class="btn" style="background: #667eea; color: white; width: 100%; margin-top: 15px;">
                            <i class="fas fa-magic"></i> Generate Text Signature
                        </button>
                    </div>
                </div>

                <div class="right-panel">
                    <div class="panel-title">
                        <i class="fas fa-eye"></i> Signature Preview
                    </div>
                    
                    <div class="editor-container" style="min-height: 300px;">
                        <div id="signatureOutput" style="text-align: center; padding: 40px;">
                            <p style="color: #aaa; font-size: 1.1rem;">Your created signature will appear here</p>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button id="useAsSignatureBtn" class="btn btn-success">
                            <i class="fas fa-check"></i> Use This Signature
                        </button>
                        <button id="downloadSignatureBtn" class="btn btn-download">
                            <i class="fas fa-download"></i> Download Signature
                        </button>
                        <button id="clearSignatureTab" class="btn btn-clear">
                            <i class="fas fa-redo"></i> Clear All
                        </button>
                    </div>

                    <!-- Saved Signatures -->
                    <div class="controls-section" style="margin-top: 20px;">
                        <div class="section-title">
                            <i class="fas fa-save"></i> Saved Signatures
                        </div>
                        <div class="templates-grid" id="savedSignatures">
                            <div style="text-align: center; color: #aaa; grid-column: 1 / -1; padding: 20px;">
                                No saved signatures yet
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Batch Process Tab -->
        <div class="tab-content" id="batch-tab">
            <div class="app-container">
                <div class="left-panel">
                    <div class="panel-title">
                        <i class="fas fa-layer-group"></i> Batch Processing
                    </div>

                    <div class="upload-section">
                        <div class="section-title">
                            <i class="fas fa-folder-open"></i> Upload Multiple Photos
                        </div>
                        <div class="upload-area" id="batchUploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop multiple photos</p>
                            <p><span>or click to browse</span></p>
                            <input type="file" id="batchInput" class="file-input" accept="image/*" multiple>
                        </div>
                        <div id="batchPreview" style="margin-top: 20px; max-height: 200px; overflow-y: auto;">
                            <p style="color: #aaa; text-align: center; padding: 20px;">No photos uploaded yet</p>
                        </div>
                    </div>

                    <div class="controls-section">
                        <div class="section-title">
                            <i class="fas fa-cogs"></i> Batch Settings
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">Output Format</label>
                            <select id="batchFormat" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <option value="png">PNG (High Quality)</option>
                                <option value="jpg">JPG (Compressed)</option>
                                <option value="pdf">PDF Document</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label class="control-label">Signature Position</label>
                            <select id="batchPosition" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <option value="bottom-right">Bottom Right</option>
                                <option value="bottom-left">Bottom Left</option>
                                <option value="top-right">Top Right</option>
                                <option value="top-left">Top Left</option>
                                <option value="center">Center</option>
                                <option value="custom">Custom Position</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label class="control-label">
                                Signature Size
                                <span class="control-value" id="batchSizeValue">15%</span>
                            </label>
                            <div class="slider-container">
                                <input type="range" id="batchSize" min="5" max="50" value="15">
                            </div>
                        </div>

                        <div class="control-group">
                            <label class="control-label">Output Quality</label>
                            <select id="batchQuality" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <option value="1">High (100%)</option>
                                <option value="0.9">Good (90%)</option>
                                <option value="0.8">Medium (80%)</option>
                                <option value="0.7">Low (70%)</option>
                            </select>
                        </div>

                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="addWatermarkBatch"> Add Watermark
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="addTimestamp"> Add Timestamp
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="renameFiles"> Auto-rename Files
                            </label>
                        </div>
                    </div>

                    <div class="action-buttons" style="margin-top: 30px;">
                        <button id="processBatchBtn" class="btn btn-primary">
                            <i class="fas fa-play"></i> Process All
                        </button>
                        <button id="clearBatchBtn" class="btn btn-clear">
                            <i class="fas fa-trash"></i> Clear Queue
                        </button>
                    </div>
                </div>

                <div class="right-panel">
                    <div class="panel-title">
                        <i class="fas fa-tasks"></i> Processing Queue
                    </div>
                    
                    <div style="flex: 1; border: 2px dashed #ddd; border-radius: 10px; padding: 20px; background: #f8f9ff;">
                        <div id="batchQueue" style="height: 100%; overflow-y: auto;">
                            <div style="text-align: center; padding: 60px 20px; color: #aaa;">
                                <i class="fas fa-layer-group" style="font-size: 60px; margin-bottom: 20px; display: block;"></i>
                                <h3>No photos in queue</h3>
                                <p>Upload multiple photos to start batch processing</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-buttons" style="margin-top: 30px;">
                        <button id="downloadAllBtn" class="btn btn-download" disabled>
                            <i class="fas fa-download"></i> Download All
                        </button>
                        <button id="createZipBtn" class="btn btn-success" disabled>
                            <i class="fas fa-file-archive"></i> Create ZIP
                        </button>
                        <button id="previewBatchBtn" class="btn" style="background: #3498db; color: white;" disabled>
                            <i class="fas fa-eye"></i> Preview All
                        </button>
                    </div>

                    <!-- Progress Bar -->
                    <div class="controls-section" style="margin-top: 20px;">
                        <div class="section-title">
                            <i class="fas fa-spinner"></i> Processing Progress
                        </div>
                        <div id="progressContainer" style="display: none;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span id="progressText">Processing: 0/0</span>
                                <span id="progressPercent">0%</span>
                            </div>
                            <div style="height: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden;">
                                <div id="progressBar" style="height: 100%; background: #2ecc71; width: 0%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                        <div id="completedStats" style="display: none; text-align: center; padding: 20px; background: #e8f5e9; border-radius: 10px;">
                            <i class="fas fa-check-circle" style="color: #2ecc71; font-size: 40px; margin-bottom: 10px;"></i>
                            <h3>Processing Complete!</h3>
                            <p id="completedText">0 files processed successfully</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification -->
        <div class="notification" id="notification">
            <i class="fas fa-check-circle"></i>
            <span>Operation completed successfully!</span>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        // DOM Elements
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const photoInput = document.getElementById('photoInput');
        const signatureInput = document.getElementById('signatureInput');
        const photoPreview = document.getElementById('photoPreview');
        const signaturePreview = document.getElementById('signaturePreview');
        const removePhotoBtn = document.getElementById('removePhotoBtn');
        const removeSignatureBtn = document.getElementById('removeSignatureBtn');
        const mergeCanvas = document.getElementById('mergeCanvas');
        const canvasPlaceholder = document.getElementById('canvasPlaceholder');
        const editorContainer = document.getElementById('editorContainer');
        const mergeBtn = document.getElementById('mergeBtn');
        const resetBtn = document.getElementById('resetBtn');
        const undoBtn = document.getElementById('undoBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const notification = document.getElementById('notification');
        const useDrawnSignature = document.getElementById('useDrawnSignature');
        
        // Control elements
        const sizeSlider = document.getElementById('sizeSlider');
        const sizeValue = document.getElementById('sizeValue');
        const opacitySlider = document.getElementById('opacitySlider');
        const opacityValue = document.getElementById('opacityValue');
        const rotationSlider = document.getElementById('rotationSlider');
        const rotationValue = document.getElementById('rotationValue');
        const positionButtons = document.querySelectorAll('.position-btn');
        const colorOptions = document.querySelectorAll('.color-option');
        const customColor = document.getElementById('customColor');
        const invertSignature = document.getElementById('invertSignature');
        const removeBackground = document.getElementById('removeBackground');
        const addShadow = document.getElementById('addShadow');
        const addBorder = document.getElementById('addBorder');
        
        // Signature tab elements
        const drawCanvas = document.getElementById('drawCanvas');
        const clearDrawBtn = document.getElementById('clearDrawBtn');
        const undoDrawBtn = document.getElementById('undoDrawBtn');
        const saveDrawBtn = document.getElementById('saveDrawBtn');
        const brushSize = document.getElementById('brushSize');
        const brushSizeValue = document.getElementById('brushSizeValue');
        const brushColor = document.getElementById('brushColor');
        const signatureText = document.getElementById('signatureText');
        const signatureFont = document.getElementById('signatureFont');
        const generateTextSignature = document.getElementById('generateTextSignature');
        const useAsSignatureBtn = document.getElementById('useAsSignatureBtn');
        const downloadSignatureBtn = document.getElementById('downloadSignatureBtn');
        const clearSignatureTab = document.getElementById('clearSignatureTab');
        const signatureOutput = document.getElementById('signatureOutput');
        const savedSignatures = document.getElementById('savedSignatures');
        
        // Batch tab elements
        const batchInput = document.getElementById('batchInput');
        const batchPreview = document.getElementById('batchPreview');
        const batchQueue = document.getElementById('batchQueue');
        const processBatchBtn = document.getElementById('processBatchBtn');
        const clearBatchBtn = document.getElementById('clearBatchBtn');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const createZipBtn = document.getElementById('createZipBtn');
        const previewBatchBtn = document.getElementById('previewBatchBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressText = document.getElementById('progressText');
        const progressPercent = document.getElementById('progressPercent');
        const progressBar = document.getElementById('progressBar');
        const completedStats = document.getElementById('completedStats');
        const completedText = document.getElementById('completedText');
        
        // State variables
        let photoImage = null;
        let signatureImage = null;
        let canvasContext = null;
        let currentSignatureElement = null;
        let currentPosition = 'center';
        let currentSize = 100;
        let currentOpacity = 100;
        let currentRotation = 0;
        let currentColor = 'original';
        let editHistory = [];
        let currentHistoryIndex = -1;
        let isDragging = false;
        let isResizing = false;
        let dragOffsetX = 0;
        let dragOffsetY = 0;
        let resizeDirection = null;
        let savedSignatureImages = [];
        let batchImages = [];
        let processedBatchImages = [];
        let drawnSignatureData = null;
        
        // Drawing variables
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let drawHistory = [];
        let currentDrawIndex = -1;
        
        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            // Initialize canvas context
            canvasContext = mergeCanvas.getContext('2d');
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize drawing canvas
            initDrawingCanvas();
            
            // Load saved signatures from localStorage
            loadSavedSignatures();
        });
        
        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;
                    
                    // Update active tab button
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    // Update active tab content
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Photo upload
            document.getElementById('photoUploadArea').addEventListener('click', () => photoInput.click());
            photoInput.addEventListener('change', (e) => handleImageUpload(e.target.files[0], 'photo'));
            
            // Signature upload
            document.getElementById('signatureUploadArea').addEventListener('click', () => signatureInput.click());
            signatureInput.addEventListener('change', (e) => handleImageUpload(e.target.files[0], 'signature'));
            
            // Remove buttons
            removePhotoBtn.addEventListener('click', () => removeImage('photo'));
            removeSignatureBtn.addEventListener('click', () => removeImage('signature'));
            
            // Control sliders
            sizeSlider.addEventListener('input', (e) => {
                currentSize = parseInt(e.target.value);
                sizeValue.textContent = currentSize + '%';
                updateSignatureElement();
                saveToHistory();
            });
            
            opacitySlider.addEventListener('input', (e) => {
                currentOpacity = parseInt(e.target.value);
                opacityValue.textContent = currentOpacity + '%';
                updateSignatureElement();
                saveToHistory();
            });
            
            rotationSlider.addEventListener('input', (e) => {
                currentRotation = parseInt(e.target.value);
                rotationValue.textContent = currentRotation + '°';
                updateSignatureElement();
                saveToHistory();
            });
            
            // Position buttons
            positionButtons.forEach(button => {
                button.addEventListener('click', () => {
                    positionButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    currentPosition = button.dataset.position;
                    positionSignature(currentPosition);
                    saveToHistory();
                });
            });
            
            // Color options
            colorOptions.forEach(option => {
                option.addEventListener('click', () => {
                    colorOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    currentColor = option.dataset.color;
                    updateSignatureElement();
                    saveToHistory();
                });
            });
            
            customColor.addEventListener('input', (e) => {
                currentColor = e.target.value;
                updateSignatureElement();
                saveToHistory();
            });
            
            // Checkbox effects
            [invertSignature, removeBackground, addShadow, addBorder].forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    updateSignatureElement();
                    saveToHistory();
                });
            });
            
            // Action buttons
            mergeBtn.addEventListener('click', mergeImages);
            resetBtn.addEventListener('click', resetAll);
            undoBtn.addEventListener('click', undoLastAction);
            downloadBtn.addEventListener('click', downloadMergedImage);
            useDrawnSignature.addEventListener('click', useDrawnSignatureHandler);
            
            // Batch processing
            batchInput.addEventListener('change', handleBatchUpload);
            processBatchBtn.addEventListener('click', processBatchImages);
            clearBatchBtn.addEventListener('click', clearBatch);
            downloadAllBtn.addEventListener('click', downloadAllBatchImages);
            createZipBtn.addEventListener('click', createZipArchive);
            
            // Signature tab buttons
            generateTextSignature.addEventListener('click', generateTextSignatureHandler);
            useAsSignatureBtn.addEventListener('click', () => useCreatedSignature('current'));
            downloadSignatureBtn.addEventListener('click', downloadCreatedSignature);
            clearSignatureTab.addEventListener('click', clearSignatureTabHandler);
            
            // Drawing controls
            brushSize.addEventListener('input', (e) => {
                brushSizeValue.textContent = e.target.value + 'px';
            });
            
            brushColor.addEventListener('input', (e) => {
                // Update active color option
                colorOptions.forEach(opt => opt.classList.remove('active'));
            });
            
            // Paper style radio buttons
            document.querySelectorAll('input[name="paperStyle"]').forEach(radio => {
                radio.addEventListener('change', updatePaperStyle);
            });
            
            // Drag and drop for upload areas
            setupDragAndDrop();
        }
        
        // Setup drag and drop
        function setupDragAndDrop() {
            const uploadAreas = [
                { element: document.getElementById('photoUploadArea'), type: 'photo' },
                { element: document.getElementById('signatureUploadArea'), type: 'signature' },
                { element: document.getElementById('batchUploadArea'), type: 'batch' }
            ];
            
            uploadAreas.forEach(area => {
                area.element.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    area.element.style.background = 'rgba(102, 126, 234, 0.15)';
                    area.element.style.borderColor = '#764ba2';
                });
                
                area.element.addEventListener('dragleave', () => {
                    area.element.style.background = 'rgba(102, 126, 234, 0.05)';
                    area.element.style.borderColor = '#667eea';
                });
                
                area.element.addEventListener('drop', (e) => {
                    e.preventDefault();
                    area.element.style.background = 'rgba(102, 126, 234, 0.05)';
                    area.element.style.borderColor = '#667eea';
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        if (area.type === 'batch') {
                            handleBatchUpload({ target: { files: files } });
                        } else {
                            handleImageUpload(files[0], area.type);
                        }
                    }
                });
            });
        }
        
        // Handle image upload
        function handleImageUpload(file, type) {
            if (!file || !file.type.startsWith('image/')) {
                showNotification('Please upload a valid image file', true);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    if (type === 'photo') {
                        photoImage = img;
                        photoPreview.src = e.target.result;
                        photoPreview.style.display = 'block';
                        removePhotoBtn.style.display = 'block';
                        showNotification('Photo uploaded successfully!');
                        
                        if (signatureImage) {
                            setupCanvas();
                            addSignatureToCanvas();
                        } else {
                            setupCanvas();
                        }
                    } else if (type === 'signature') {
                        signatureImage = img;
                        signaturePreview.src = e.target.result;
                        signaturePreview.style.display = 'block';
                        removeSignatureBtn.style.display = 'block';
                        showNotification('Signature uploaded successfully!');
                        
                        if (photoImage) {
                            addSignatureToCanvas();
                        }
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // Remove image
        function removeImage(type) {
            if (type === 'photo') {
                photoImage = null;
                photoPreview.src = '';
                photoPreview.style.display = 'none';
                removePhotoBtn.style.display = 'none';
                clearCanvas();
            } else if (type === 'signature') {
                signatureImage = null;
                signaturePreview.src = '';
                signaturePreview.style.display = 'none';
                removeSignatureBtn.style.display = 'none';
                if (currentSignatureElement) {
                    currentSignatureElement.remove();
                    currentSignatureElement = null;
                }
            }
        }
        
        // Setup canvas
        function setupCanvas() {
            if (!photoImage) return;
            
            const maxWidth = editorContainer.clientWidth - 40;
            const maxHeight = editorContainer.clientHeight - 40;
            
            let width = photoImage.width;
            let height = photoImage.height;
            
            // Scale image to fit container
            if (width > maxWidth) {
                const ratio = maxWidth / width;
                width = maxWidth;
                height = height * ratio;
            }
            
            if (height > maxHeight) {
                const ratio = maxHeight / height;
                height = maxHeight;
                width = width * ratio;
            }
            
            // Set canvas dimensions
            mergeCanvas.width = width;
            mergeCanvas.height = height;
            
            // Draw image on canvas
            canvasContext.clearRect(0, 0, mergeCanvas.width, mergeCanvas.height);
            canvasContext.drawImage(photoImage, 0, 0, width, height);
            
            // Show canvas
            canvasPlaceholder.style.display = 'none';
            mergeCanvas.style.display = 'block';
            
            // Clear history
            editHistory = [];
            currentHistoryIndex = -1;
        }
        
        // Clear canvas
        function clearCanvas() {
            canvasContext.clearRect(0, 0, mergeCanvas.width, mergeCanvas.height);
            canvasPlaceholder.style.display = 'block';
            mergeCanvas.style.display = 'none';
            if (currentSignatureElement) {
                currentSignatureElement.remove();
                currentSignatureElement = null;
            }
        }
        
        // Add signature to canvas
        function addSignatureToCanvas() {
            if (!signatureImage || !photoImage) return;
            
            // Remove existing signature element
            if (currentSignatureElement) {
                currentSignatureElement.remove();
            }
            
            // Create draggable signature element
            currentSignatureElement = createDraggableElement();
            
            // Position signature
            positionSignature(currentPosition);
            
            // Update signature appearance
            updateSignatureElement();
            
            // Add to history
            saveToHistory();
        }
        
        // Create draggable element
        function createDraggableElement() {
            const element = document.createElement('div');
            element.className = 'draggable-element';
            element.style.position = 'absolute';
            
            // Add signature image
            const img = document.createElement('img');
            img.src = signatureImage.src;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'contain';
            element.appendChild(img);
            
            // Add resize handles
            const handles = ['nw', 'n', 'ne', 'w', 'e', 'sw', 's', 'se'];
            handles.forEach(handle => {
                const handleDiv = document.createElement('div');
                handleDiv.className = `resize-handle ${handle}`;
                handleDiv.addEventListener('mousedown', (e) => startResize(e, handle));
                element.appendChild(handleDiv);
            });
            
            // Add control buttons
            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'element-controls';
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'control-btn';
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.title = 'Delete Signature';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                element.remove();
                currentSignatureElement = null;
                saveToHistory();
            });
            
            const frontBtn = document.createElement('button');
            frontBtn.className = 'control-btn';
            frontBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
            frontBtn.title = 'Bring to Front';
            frontBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                element.style.zIndex = '1000';
            });
            
            const backBtn = document.createElement('button');
            backBtn.className = 'control-btn';
            backBtn.innerHTML = '<i class="fas fa-arrow-down"></i>';
            backBtn.title = 'Send to Back';
            backBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                element.style.zIndex = '1';
            });
            
            controlsDiv.appendChild(deleteBtn);
            controlsDiv.appendChild(frontBtn);
            controlsDiv.appendChild(backBtn);
            element.appendChild(controlsDiv);
            
            // Make draggable
            element.addEventListener('mousedown', startDrag);
            
            // Add to editor container
            editorContainer.appendChild(element);
            
            return element;
        }
        
        // Start dragging
        function startDrag(e) {
            if (e.target.classList.contains('resize-handle')) return;
            
            isDragging = true;
            const element = e.currentTarget;
            const rect = element.getBoundingClientRect();
            const containerRect = editorContainer.getBoundingClientRect();
            
            dragOffsetX = e.clientX - rect.left + containerRect.left;
            dragOffsetY = e.clientY - rect.top + containerRect.top;
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
            
            e.preventDefault();
        }
        
        // Drag element
        function drag(e) {
            if (!isDragging || !currentSignatureElement) return;
            
            const containerRect = editorContainer.getBoundingClientRect();
            let x = e.clientX - dragOffsetX;
            let y = e.clientY - dragOffsetY;
            
            // Constrain within container
            const maxX = containerRect.width - currentSignatureElement.offsetWidth;
            const maxY = containerRect.height - currentSignatureElement.offsetHeight;
            
            x = Math.max(0, Math.min(x, maxX));
            y = Math.max(0, Math.min(y, maxY));
            
            currentSignatureElement.style.left = x + 'px';
            currentSignatureElement.style.top = y + 'px';
        }
        
        // Stop dragging
        function stopDrag() {
            isDragging = false;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);
            
            if (currentSignatureElement) {
                saveToHistory();
            }
        }
        
        // Start resizing
        function startResize(e, direction) {
            isResizing = true;
            resizeDirection = direction;
            const element = e.currentTarget.parentElement;
            const startWidth = element.offsetWidth;
            const startHeight = element.offsetHeight;
            const startX = element.offsetLeft;
            const startY = element.offsetTop;
            const startMouseX = e.clientX;
            const startMouseY = e.clientY;
            
            function handleResize(e) {
                if (!isResizing) return;
                
                let newWidth = startWidth;
                let newHeight = startHeight;
                let newX = startX;
                let newY = startY;
                
                const deltaX = e.clientX - startMouseX;
                const deltaY = e.clientY - startMouseY;
                
                // Calculate new dimensions based on resize direction
                switch(resizeDirection) {
                    case 'e':
                        newWidth = Math.max(50, startWidth + deltaX);
                        break;
                    case 'w':
                        newWidth = Math.max(50, startWidth - deltaX);
                        newX = startX + deltaX;
                        break;
                    case 's':
                        newHeight = Math.max(50, startHeight + deltaY);
                        break;
                    case 'n':
                        newHeight = Math.max(50, startHeight - deltaY);
                        newY = startY + deltaY;
                        break;
                    case 'se':
                        newWidth = Math.max(50, startWidth + deltaX);
                        newHeight = Math.max(50, startHeight + deltaY);
                        break;
                    case 'sw':
                        newWidth = Math.max(50, startWidth - deltaX);
                        newHeight = Math.max(50, startHeight + deltaY);
                        newX = startX + deltaX;
                        break;
                    case 'ne':
                        newWidth = Math.max(50, startWidth + deltaX);
                        newHeight = Math.max(50, startHeight - deltaY);
                        newY = startY + deltaY;
                        break;
                    case 'nw':
                        newWidth = Math.max(50, startWidth - deltaX);
                        newHeight = Math.max(50, startHeight - deltaY);
                        newX = startX + deltaX;
                        newY = startY + deltaY;
                        break;
                }
                
                // Update element
                element.style.width = newWidth + 'px';
                element.style.height = newHeight + 'px';
                element.style.left = newX + 'px';
                element.style.top = newY + 'px';
                
                // Update size slider
                const containerWidth = editorContainer.clientWidth;
                const newSizePercent = Math.round((newWidth / containerWidth) * 100);
                sizeSlider.value = newSizePercent;
                sizeValue.textContent = newSizePercent + '%';
                currentSize = newSizePercent;
            }
            
            function stopResize() {
                isResizing = false;
                resizeDirection = null;
                document.removeEventListener('mousemove', handleResize);
                document.removeEventListener('mouseup', stopResize);
                
                saveToHistory();
            }
            
            document.addEventListener('mousemove', handleResize);
            document.addEventListener('mouseup', stopResize);
            
            e.preventDefault();
            e.stopPropagation();
        }
        
        // Position signature
        function positionSignature(position) {
            if (!currentSignatureElement) return;
            
            const containerWidth = editorContainer.clientWidth;
            const containerHeight = editorContainer.clientHeight;
            const elementWidth = currentSignatureElement.offsetWidth || 100;
            const elementHeight = currentSignatureElement.offsetHeight || 50;
            const padding = 20;
            
            let x = 0;
            let y = 0;
            
            switch(position) {
                case 'top-left':
                    x = padding;
                    y = padding;
                    break;
                case 'top-center':
                    x = (containerWidth - elementWidth) / 2;
                    y = padding;
                    break;
                case 'top-right':
                    x = containerWidth - elementWidth - padding;
                    y = padding;
                    break;
                case 'middle-left':
                    x = padding;
                    y = (containerHeight - elementHeight) / 2;
                    break;
                case 'center':
                    x = (containerWidth - elementWidth) / 2;
                    y = (containerHeight - elementHeight) / 2;
                    break;
                case 'middle-right':
                    x = containerWidth - elementWidth - padding;
                    y = (containerHeight - elementHeight) / 2;
                    break;
                case 'bottom-left':
                    x = padding;
                    y = containerHeight - elementHeight - padding;
                    break;
                case 'bottom-center':
                    x = (containerWidth - elementWidth) / 2;
                    y = containerHeight - elementHeight - padding;
                    break;
                case 'bottom-right':
                    x = containerWidth - elementWidth - padding;
                    y = containerHeight - elementHeight - padding;
                    break;
            }
            
            currentSignatureElement.style.left = x + 'px';
            currentSignatureElement.style.top = y + 'px';
        }
        
        // Update signature element
        function updateSignatureElement() {
            if (!currentSignatureElement) return;
            
            const img = currentSignatureElement.querySelector('img');
            if (!img) return;
            
            // Update size
            const containerWidth = editorContainer.clientWidth;
            const newWidth = (containerWidth * currentSize) / 100;
            currentSignatureElement.style.width = newWidth + 'px';
            currentSignatureElement.style.height = 'auto';
            
            // Update opacity
            currentSignatureElement.style.opacity = currentOpacity / 100;
            
            // Update rotation
            currentSignatureElement.style.transform = `rotate(${currentRotation}deg)`;
            
            // Apply color filter
            let filter = '';
            if (currentColor !== 'original') {
                // Convert color to filter
                const color = currentColor === '#ffffff' ? '255,255,255' : 
                             currentColor === '#000000' ? '0,0,0' :
                             currentColor === '#0000ff' ? '0,0,255' :
                             currentColor === '#ff0000' ? '255,0,0' :
                             currentColor === '#008000' ? '0,128,0' : currentColor;
                
                if (color.startsWith('#')) {
                    // Convert hex to RGB
                    const r = parseInt(color.slice(1, 3), 16);
                    const g = parseInt(color.slice(3, 5), 16);
                    const b = parseInt(color.slice(5, 7), 16);
                    filter += `sepia(100%) saturate(10000%) hue-rotate(${getHueRotation(r, g, b)}deg) brightness(${getBrightness(r, g, b)}%) contrast(${getContrast(r, g, b)}%)`;
                }
            }
            
            if (invertSignature.checked) {
                filter += ' invert(100%)';
            }
            
            if (removeBackground.checked) {
                // This would require more advanced processing
                currentSignatureElement.style.background = 'transparent';
            }
            
            if (addShadow.checked) {
                currentSignatureElement.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
            } else {
                currentSignatureElement.style.boxShadow = 'none';
            }
            
            if (addBorder.checked) {
                currentSignatureElement.style.border = '2px solid #000000';
            } else {
                currentSignatureElement.style.border = '2px dashed transparent';
            }
            
            img.style.filter = filter.trim();
        }
        
        // Helper functions for color filter
        function getHueRotation(r, g, b) {
            // Simplified hue rotation calculation
            return Math.random() * 360;
        }
        
        function getBrightness(r, g, b) {
            const brightness = (r + g + b) / 3;
            return (brightness / 255) * 100;
        }
        
        function getContrast(r, g, b) {
            return 100; // Default contrast
        }
        
        // Save to history
        function saveToHistory() {
            if (!currentSignatureElement) return;
            
            const state = {
                left: currentSignatureElement.style.left,
                top: currentSignatureElement.style.top,
                width: currentSignatureElement.style.width,
                height: currentSignatureElement.style.height,
                opacity: currentOpacity,
                size: currentSize,
                rotation: currentRotation,
                color: currentColor,
                position: currentPosition
            };
            
            // Remove future states if we're not at the end
            if (currentHistoryIndex < editHistory.length - 1) {
                editHistory = editHistory.slice(0, currentHistoryIndex + 1);
            }
            
            editHistory.push(state);
            currentHistoryIndex++;
            
            updateHistoryDisplay();
        }
        
        // Undo last action
        function undoLastAction() {
            if (currentHistoryIndex <= 0 || !currentSignatureElement) return;
            
            currentHistoryIndex--;
            const state = editHistory[currentHistoryIndex];
            
            currentSignatureElement.style.left = state.left;
            currentSignatureElement.style.top = state.top;
            currentSignatureElement.style.width = state.width;
            currentSignatureElement.style.height = state.height;
            currentOpacity = state.opacity;
            currentSize = state.size;
            currentRotation = state.rotation;
            currentColor = state.color;
            currentPosition = state.position;
            
            // Update controls
            opacitySlider.value = currentOpacity;
            opacityValue.textContent = currentOpacity + '%';
            sizeSlider.value = currentSize;
            sizeValue.textContent = currentSize + '%';
            rotationSlider.value = currentRotation;
            rotationValue.textContent = currentRotation + '°';
            
            // Update position buttons
            positionButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.position === currentPosition);
            });
            
            // Update color options
            colorOptions.forEach(opt => {
                opt.classList.toggle('active', opt.dataset.color === currentColor);
            });
            
            updateSignatureElement();
            updateHistoryDisplay();
        }
        
        // Update history display
        function updateHistoryDisplay() {
            const historyStack = document.getElementById('historyStack');
            historyStack.innerHTML = '';
            
            if (editHistory.length === 0) {
                historyStack.innerHTML = '<p style="color: #aaa; text-align: center; padding: 20px;">No edit history yet</p>';
                return;
            }
            
            editHistory.forEach((state, index) => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.textContent = `Edit ${index + 1}: Position ${state.position}, Size ${state.size}%`;
                item.style.opacity = index === currentHistoryIndex ? 1 : 0.6;
                item.style.fontWeight = index === currentHistoryIndex ? 'bold' : 'normal';
                
                item.addEventListener('click', () => {
                    currentHistoryIndex = index;
                    const state = editHistory[index];
                    
                    if (currentSignatureElement) {
                        currentSignatureElement.style.left = state.left;
                        currentSignatureElement.style.top = state.top;
                        currentSignatureElement.style.width = state.width;
                        currentSignatureElement.style.height = state.height;
                        currentOpacity = state.opacity;
                        currentSize = state.size;
                        currentRotation = state.rotation;
                        currentColor = state.color;
                        currentPosition = state.position;
                        
                        // Update controls
                        opacitySlider.value = currentOpacity;
                        opacityValue.textContent = currentOpacity + '%';
                        sizeSlider.value = currentSize;
                        sizeValue.textContent = currentSize + '%';
                        rotationSlider.value = currentRotation;
                        rotationValue.textContent = currentRotation + '°';
                        
                        updateSignatureElement();
                        updateHistoryDisplay();
                    }
                });
                
                historyStack.appendChild(item);
            });
            
            historyStack.scrollTop = historyStack.scrollHeight;
        }
        
        // Merge images
        function mergeImages() {
            if (!photoImage || !signatureImage) {
                showNotification('Please upload both photo and signature first!', true);
                return;
            }
            
            // Draw photo on canvas
            canvasContext.clearRect(0, 0, mergeCanvas.width, mergeCanvas.height);
            canvasContext.drawImage(photoImage, 0, 0, mergeCanvas.width, mergeCanvas.height);
            
            // Calculate signature position and size
            if (currentSignatureElement) {
                const elementRect = currentSignatureElement.getBoundingClientRect();
                const containerRect = editorContainer.getBoundingClientRect();
                
                const x = elementRect.left - containerRect.left;
                const y = elementRect.top - containerRect.top;
                const width = elementRect.width;
                const height = elementRect.height;
                
                // Save canvas state
                canvasContext.save();
                
                // Apply rotation
                canvasContext.translate(x + width / 2, y + height / 2);
                canvasContext.rotate(currentRotation * Math.PI / 180);
                canvasContext.translate(-(x + width / 2), -(y + height / 2));
                
                // Apply opacity
                canvasContext.globalAlpha = currentOpacity / 100;
                
                // Draw signature
                canvasContext.drawImage(signatureImage, x, y, width, height);
                
                // Restore canvas state
                canvasContext.restore();
                
                showNotification('Images merged successfully!');
            }
        }
        
        // Download merged image
        function downloadMergedImage() {
            if (!photoImage) {
                showNotification('Please upload a photo first!', true);
                return;
            }
            
            mergeImages(); // Ensure latest merge is rendered
            
            const link = document.createElement('a');
            link.download = `merged-photo-${Date.now()}.png`;
            link.href = mergeCanvas.toDataURL('image/png');
            link.click();
            showNotification('Image downloaded successfully!');
        }
        
        // Reset all
        function resetAll() {
            if (confirm('Are you sure you want to reset everything?')) {
                removeImage('photo');
                removeImage('signature');
                clearCanvas();
                
                // Reset controls
                sizeSlider.value = 100;
                sizeValue.textContent = '100%';
                opacitySlider.value = 100;
                opacityValue.textContent = '100%';
                rotationSlider.value = 0;
                rotationValue.textContent = '0°';
                
                // Reset position
                positionButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.position === 'center');
                });
                currentPosition = 'center';
                
                // Reset color
                colorOptions.forEach(opt => {
                    opt.classList.toggle('active', opt.dataset.color === 'original');
                });
                currentColor = 'original';
                
                // Reset checkboxes
                invertSignature.checked = false;
                removeBackground.checked = false;
                addShadow.checked = false;
                addBorder.checked = false;
                
                // Clear history
                editHistory = [];
                currentHistoryIndex = -1;
                updateHistoryDisplay();
                
                showNotification('All settings reset!');
            }
        }
        
        // Initialize drawing canvas
        function initDrawingCanvas() {
            const ctx = drawCanvas.getContext('2d');
            drawCanvas.width = drawCanvas.offsetWidth;
            drawCanvas.height = drawCanvas.offsetHeight;
            
            // Set initial background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, drawCanvas.width, drawCanvas.height);
            
            // Add event listeners for drawing
            drawCanvas.addEventListener('mousedown', startDrawing);
            drawCanvas.addEventListener('mousemove', draw);
            drawCanvas.addEventListener('mouseup', stopDrawing);
            drawCanvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events for mobile
            drawCanvas.addEventListener('touchstart', startDrawingTouch);
            drawCanvas.addEventListener('touchmove', drawTouch);
            drawCanvas.addEventListener('touchend', stopDrawing);
            
            // Clear button
            clearDrawBtn.addEventListener('click', () => {
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, drawCanvas.width, drawCanvas.height);
                drawHistory = [];
                currentDrawIndex = -1;
            });
            
            // Undo button
            undoDrawBtn.addEventListener('click', () => {
                if (currentDrawIndex > 0) {
                    currentDrawIndex--;
                    const img = new Image();
                    img.onload = () => {
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, drawCanvas.width, drawCanvas.height);
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = drawHistory[currentDrawIndex];
                } else {
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, drawCanvas.width, drawCanvas.height);
                    drawHistory = [];
                    currentDrawIndex = -1;
                }
            });
            
            // Save button
            saveDrawBtn.addEventListener('click', () => {
                drawnSignatureData = drawCanvas.toDataURL('image/png');
                
                // Display preview
                signatureOutput.innerHTML = `
                    <img src="${drawnSignatureData}" alt="Drawn Signature" style="max-width: 100%; max-height: 200px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                    <p style="margin-top: 10px; color: #666;">Your drawn signature</p>
                `;
                
                // Save to localStorage
                saveSignatureToStorage(drawnSignatureData, 'Drawn Signature');
                
                showNotification('Signature saved successfully!');
            });
        }
        
        // Drawing functions
        function startDrawing(e) {
            isDrawing = true;
            const rect = drawCanvas.getBoundingClientRect();
            [lastX, lastY] = [e.clientX - rect.left, e.clientY - rect.top];
            saveDrawState();
        }
        
        function startDrawingTouch(e) {
            e.preventDefault();
            isDrawing = true;
            const rect = drawCanvas.getBoundingClientRect();
            const touch = e.touches[0];
            [lastX, lastY] = [touch.clientX - rect.left, touch.clientY - rect.top];
            saveDrawState();
        }
        
        function draw(e) {
            if (!isDrawing) return;
            
            const ctx = drawCanvas.getContext('2d');
            const rect = drawCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.strokeStyle = brushColor.value;
            ctx.lineWidth = brushSize.value;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
            
            [lastX, lastY] = [x, y];
        }
        
        function drawTouch(e) {
            e.preventDefault();
            if (!isDrawing) return;
            
            const ctx = drawCanvas.getContext('2d');
            const rect = drawCanvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            ctx.strokeStyle = brushColor.value;
            ctx.lineWidth = brushSize.value;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
            
            [lastX, lastY] = [x, y];
        }
        
        function stopDrawing() {
            isDrawing = false;
        }
        
        function saveDrawState() {
            if (currentDrawIndex < drawHistory.length - 1) {
                drawHistory = drawHistory.slice(0, currentDrawIndex + 1);
            }
            drawHistory.push(drawCanvas.toDataURL());
            currentDrawIndex++;
        }
        
        // Update paper style
        function updatePaperStyle() {
            const ctx = drawCanvas.getContext('2d');
            const style = document.querySelector('input[name="paperStyle"]:checked').value;
            
            // Clear canvas
            ctx.fillStyle = style === 'transparent' ? 'rgba(255,255,255,0)' : 'white';
            ctx.fillRect(0, 0, drawCanvas.width, drawCanvas.height);
            
            if (style === 'lined') {
                ctx.strokeStyle = '#e0e0e0';
                ctx.lineWidth = 1;
                
                for (let y = 20; y < drawCanvas.height; y += 20) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(drawCanvas.width, y);
                    ctx.stroke();
                }
            } else if (style === 'grid') {
                ctx.strokeStyle = '#f0f0f0';
                ctx.lineWidth = 1;
                
                // Vertical lines
                for (let x = 20; x < drawCanvas.width; x += 20) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, drawCanvas.height);
                    ctx.stroke();
                }
                
                // Horizontal lines
                for (let y = 20; y < drawCanvas.height; y += 20) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(drawCanvas.width, y);
                    ctx.stroke();
                }
            }
        }
        
        // Generate text signature
        function generateTextSignatureHandler() {
            const text = signatureText.value.trim();
            if (!text) {
                showNotification('Please enter your name first!', true);
                return;
            }
            
            const canvas = document.createElement('canvas');
            canvas.width = 600;
            canvas.height = 200;
            const ctx = canvas.getContext('2d');
            
            // Set background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Set text style
            ctx.font = `bold 60px ${signatureFont.value}`;
            ctx.fillStyle = '#000000';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Draw text
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);
            
            // Add underline
            ctx.beginPath();
            ctx.moveTo(canvas.width / 4, canvas.height / 2 + 40);
            ctx.lineTo(canvas.width * 3 / 4, canvas.height / 2 + 40);
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // Display preview
            const dataUrl = canvas.toDataURL('image/png');
            signatureOutput.innerHTML = `
                <img src="${dataUrl}" alt="Text Signature" style="max-width: 100%; max-height: 200px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <p style="margin-top: 10px; color: #666;">Your text signature: ${text}</p>
            `;
            
            // Save to localStorage
            saveSignatureToStorage(dataUrl, `Text: ${text}`);
            
            showNotification('Text signature generated successfully!');
        }
        
        // Use drawn signature
        function useDrawnSignatureHandler() {
            if (!drawnSignatureData) {
                showNotification('Please create or select a signature first!', true);
                return;
            }
            
            const img = new Image();
            img.onload = () => {
                signatureImage = img;
                signaturePreview.src = drawnSignatureData;
                signaturePreview.style.display = 'block';
                removeSignatureBtn.style.display = 'block';
                
                if (photoImage) {
                    addSignatureToCanvas();
                }
                
                showNotification('Signature applied successfully!');
                
                // Switch to merge tab
                tabButtons[0].click();
            };
            img.src = drawnSignatureData;
        }
        
        // Use created signature
        function useCreatedSignature(type) {
            let dataUrl = '';
            
            if (type === 'current') {
                const img = signatureOutput.querySelector('img');
                if (!img) {
                    showNotification('Please create a signature first!', true);
                    return;
                }
                dataUrl = img.src;
            }
            
            const img = new Image();
            img.onload = () => {
                signatureImage = img;
                signaturePreview.src = dataUrl;
                signaturePreview.style.display = 'block';
                removeSignatureBtn.style.display = 'block';
                
                if (photoImage) {
                    addSignatureToCanvas();
                }
                
                showNotification('Signature applied successfully!');
                
                // Switch to merge tab
                tabButtons[0].click();
            };
            img.src = dataUrl;
        }
        
        // Download created signature
        function downloadCreatedSignature() {
            const img = signatureOutput.querySelector('img');
            if (!img) {
                showNotification('Please create a signature first!', true);
                return;
            }
            
            const link = document.createElement('a');
            link.download = `signature-${Date.now()}.png`;
            link.href = img.src;
            link.click();
            showNotification('Signature downloaded successfully!');
        }
        
        // Clear signature tab
        function clearSignatureTabHandler() {
            if (confirm('Clear all signatures from this tab?')) {
                signatureOutput.innerHTML = '<p style="color: #aaa; font-size: 1.1rem;">Your created signature will appear here</p>';
                signatureText.value = '';
                drawnSignatureData = null;
                
                // Clear drawing canvas
                const ctx = drawCanvas.getContext('2d');
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, drawCanvas.width, drawCanvas.height);
                drawHistory = [];
                currentDrawIndex = -1;
                
                showNotification('Signature tab cleared!');
            }
        }
        
        // Save signature to localStorage
        function saveSignatureToStorage(dataUrl, name) {
            const signature = {
                id: Date.now(),
                name: name,
                dataUrl: dataUrl,
                date: new Date().toLocaleDateString()
            };
            
            savedSignatureImages.push(signature);
            
            // Save to localStorage (limit to 10 signatures)
            if (savedSignatureImages.length > 10) {
                savedSignatureImages.shift();
            }
            
            localStorage.setItem('savedSignatures', JSON.stringify(savedSignatureImages));
            updateSavedSignaturesDisplay();
        }
        
        // Load saved signatures from localStorage
        function loadSavedSignatures() {
            const saved = localStorage.getItem('savedSignatures');
            if (saved) {
                savedSignatureImages = JSON.parse(saved);
                updateSavedSignaturesDisplay();
            }
        }
        
        // Update saved signatures display
        function updateSavedSignaturesDisplay() {
            savedSignatures.innerHTML = '';
            
            if (savedSignatureImages.length === 0) {
                savedSignatures.innerHTML = '<div style="text-align: center; color: #aaa; grid-column: 1 / -1; padding: 20px;">No saved signatures yet</div>';
                return;
            }
            
            savedSignatureImages.forEach((sig, index) => {
                const card = document.createElement('div');
                card.className = 'template-card';
                card.style.cursor = 'pointer';
                
                card.innerHTML = `
                    <div class="template-icon">
                        <i class="fas fa-signature"></i>
                    </div>
                    <h4 style="font-size: 0.9rem; margin: 5px 0;">${sig.name.length > 10 ? sig.name.substring(0, 10) + '...' : sig.name}</h4>
                    <p style="font-size: 0.7rem; color: #666;">${sig.date}</p>
                `;
                
                card.addEventListener('click', () => {
                    // Display signature
                    signatureOutput.innerHTML = `
                        <img src="${sig.dataUrl}" alt="Saved Signature" style="max-width: 100%; max-height: 200px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                        <p style="margin-top: 10px; color: #666;">${sig.name}</p>
                    `;
                    
                    // Set as current signature data
                    drawnSignatureData = sig.dataUrl;
                    
                    showNotification('Signature loaded!');
                });
                
                savedSignatures.appendChild(card);
            });
        }
        
        // Handle batch upload
        function handleBatchUpload(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            
            batchPreview.innerHTML = '';
            batchQueue.innerHTML = '';
            batchImages = [];
            
            Array.from(files).forEach((file, index) => {
                if (!file.type.startsWith('image/')) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        batchImages.push({
                            id: Date.now() + index,
                            file: file,
                            dataUrl: e.target.result,
                            image: img,
                            name: file.name,
                            processed: false
                        });
                        
                        updateBatchPreview();
                        updateBatchQueue();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
            
            if (batchImages.length > 0) {
                showNotification(`${batchImages.length} images added to batch queue!`);
                downloadAllBtn.disabled = false;
                createZipBtn.disabled = false;
                previewBatchBtn.disabled = false;
            }
        }
        
        // Update batch preview
        function updateBatchPreview() {
            batchPreview.innerHTML = '';
            
            if (batchImages.length === 0) {
                batchPreview.innerHTML = '<p style="color: #aaa; text-align: center; padding: 20px;">No photos uploaded yet</p>';
                return;
            }
            
            batchImages.forEach((img, index) => {
                if (index >= 3) return; // Show only first 3
                
                const previewDiv = document.createElement('div');
                previewDiv.style.display = 'flex';
                previewDiv.style.alignItems = 'center';
                previewDiv.style.gap = '10px';
                previewDiv.style.marginBottom = '10px';
                previewDiv.style.padding = '10px';
                previewDiv.style.background = '#f8f9ff';
                previewDiv.style.borderRadius = '8px';
                
                previewDiv.innerHTML = `
                    <img src="${img.dataUrl}" alt="${img.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;">
                    <div style="flex: 1;">
                        <p style="margin: 0; font-size: 0.9rem; color: #333;">${img.name}</p>
                        <p style="margin: 0; font-size: 0.8rem; color: #666;">${img.image.width} × ${img.image.height}</p>
                    </div>
                    <button class="remove-btn" data-index="${index}" style="position: static; transform: none;">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                batchPreview.appendChild(previewDiv);
            });
            
            if (batchImages.length > 3) {
                const moreText = document.createElement('p');
                moreText.style.textAlign = 'center';
                moreText.style.color = '#666';
                moreText.style.marginTop = '10px';
                moreText.textContent = `+ ${batchImages.length - 3} more images`;
                batchPreview.appendChild(moreText);
            }
            
            // Add remove button event listeners
            batchPreview.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(btn.dataset.index);
                    batchImages.splice(index, 1);
                    updateBatchPreview();
                    updateBatchQueue();
                });
            });
        }
        
        // Update batch queue
        function updateBatchQueue() {
            batchQueue.innerHTML = '';
            
            if (batchImages.length === 0) {
                batchQueue.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #aaa;">
                        <i class="fas fa-layer-group" style="font-size: 60px; margin-bottom: 20px; display: block;"></i>
                        <h3>No photos in queue</h3>
                        <p>Upload multiple photos to start batch processing</p>
                    </div>
                `;
                downloadAllBtn.disabled = true;
                createZipBtn.disabled = true;
                previewBatchBtn.disabled = true;
                return;
            }
            
            batchImages.forEach((img, index) => {
                const queueItem = document.createElement('div');
                queueItem.className = 'history-item';
                queueItem.style.display = 'flex';
                queueItem.style.alignItems = 'center';
                queueItem.style.gap = '15px';
                
                queueItem.innerHTML = `
                    <div style="width: 40px; height: 40px; background: #f0f0f0; border-radius: 5px; display: flex; align-items: center; justify-content: center;">
                        ${index + 1}
                    </div>
                    <div style="flex: 1;">
                        <p style="margin: 0; font-weight: 600; color: #333;">${img.name}</p>
                        <p style="margin: 0; font-size: 0.8rem; color: #666;">Status: ${img.processed ? 'Processed' : 'Pending'}</p>
                    </div>
                    <div style="width: 20px; height: 20px; border-radius: 50%; background: ${img.processed ? '#2ecc71' : '#f39c12'};"></div>
                `;
                
                batchQueue.appendChild(queueItem);
            });
        }
        
        // Process batch images
        async function processBatchImages() {
            if (batchImages.length === 0 || !signatureImage) {
                showNotification('Please upload photos and a signature first!', true);
                return;
            }
            
            progressContainer.style.display = 'block';
            completedStats.style.display = 'none';
            processedBatchImages = [];
            
            const total = batchImages.length;
            let processed = 0;
            
            for (let i = 0; i < batchImages.length; i++) {
                const batchImg = batchImages[i];
                
                // Update progress
                processed++;
                const percent = Math.round((processed / total) * 100);
                progressText.textContent = `Processing: ${processed}/${total}`;
                progressPercent.textContent = `${percent}%`;
                progressBar.style.width = `${percent}%`;
                
                // Create canvas for this image
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Set canvas size to match image
                canvas.width = batchImg.image.width;
                canvas.height = batchImg.image.height;
                
                // Draw image
                ctx.drawImage(batchImg.image, 0, 0);
                
                // Calculate signature position and size
                const sigWidth = canvas.width * (parseInt(document.getElementById('batchSize').value) / 100);
                const sigHeight = (signatureImage.height / signatureImage.width) * sigWidth;
                
                let x, y;
                const position = document.getElementById('batchPosition').value;
                const padding = canvas.width * 0.05;
                
                switch(position) {
                    case 'bottom-right':
                        x = canvas.width - sigWidth - padding;
                        y = canvas.height - sigHeight - padding;
                        break;
                    case 'bottom-left':
                        x = padding;
                        y = canvas.height - sigHeight - padding;
                        break;
                    case 'top-right':
                        x = canvas.width - sigWidth - padding;
                        y = padding;
                        break;
                    case 'top-left':
                        x = padding;
                        y = padding;
                        break;
                    case 'center':
                        x = (canvas.width - sigWidth) / 2;
                        y = (canvas.height - sigHeight) / 2;
                        break;
                    default:
                        x = canvas.width - sigWidth - padding;
                        y = canvas.height - sigHeight - padding;
                }
                
                // Draw signature
                ctx.drawImage(signatureImage, x, y, sigWidth, sigHeight);
                
                // Mark as processed
                batchImg.processed = true;
                batchImg.processedDataUrl = canvas.toDataURL('image/png', parseFloat(document.getElementById('batchQuality').value));
                processedBatchImages.push(batchImg);
                
                // Update queue display
                updateBatchQueue();
                
                // Small delay to show progress
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // Hide progress, show completion
            progressContainer.style.display = 'none';
            completedStats.style.display = 'block';
            completedText.textContent = `${processedBatchImages.length} files processed successfully`;
            
            showNotification('Batch processing completed!');
        }
        
        // Download all batch images
        function downloadAllBatchImages() {
            if (processedBatchImages.length === 0) {
                showNotification('Please process images first!', true);
                return;
            }
            
            processedBatchImages.forEach((img, index) => {
                const link = document.createElement('a');
                link.download = `processed-${img.name}`;
                link.href = img.processedDataUrl;
                link.click();
                
                // Stagger downloads to avoid browser issues
                setTimeout(() => {
                    // Clean up
                    URL.revokeObjectURL(link.href);
                }, 100 * index);
            });
            
            showNotification(`Downloading ${processedBatchImages.length} files...`);
        }
        
        // Create ZIP archive
        async function createZipArchive() {
            if (processedBatchImages.length === 0) {
                showNotification('Please process images first!', true);
                return;
            }
            
            const zip = new JSZip();
            const folder = zip.folder("processed-signatures");
            
            processedBatchImages.forEach((img, index) => {
                // Convert data URL to blob
                const blob = dataURLtoBlob(img.processedDataUrl);
                folder.file(img.name, blob);
            });
            
            const content = await zip.generateAsync({type: "blob"});
            saveAs(content, "processed-signatures.zip");
            
            showNotification('ZIP archive created and downloaded!');
        }
        
        // Clear batch
        function clearBatch() {
            if (confirm('Clear all images from batch queue?')) {
                batchImages = [];
                processedBatchImages = [];
                updateBatchPreview();
                updateBatchQueue();
                progressContainer.style.display = 'none';
                completedStats.style.display = 'none';
                showNotification('Batch queue cleared!');
            }
        }
        
        // Helper function: Convert data URL to blob
        function dataURLtoBlob(dataURL) {
            const parts = dataURL.split(';base64,');
            const contentType = parts[0].split(':')[1];
            const raw = window.atob(parts[1]);
            const rawLength = raw.length;
            const uInt8Array = new Uint8Array(rawLength);
            
            for (let i = 0; i < rawLength; ++i) {
                uInt8Array[i] = raw.charCodeAt(i);
            }
            
            return new Blob([uInt8Array], {type: contentType});
        }
        
        // Show notification
        function showNotification(message, isError = false) {
            notification.querySelector('span').textContent = message;
            notification.className = 'notification';
            
            if (isError) {
                notification.classList.add('error');
                notification.querySelector('i').className = 'fas fa-exclamation-circle';
            } else {
                notification.querySelector('i').className = 'fas fa-check-circle';
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
